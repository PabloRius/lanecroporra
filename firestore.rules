rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // User documents
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Group documents
    match /groups/{groupId} {
      allow read: if request.auth != null;

      // Only the creator can create a group
      allow create: if request.auth != null 
        && request.resource.data.creatorId == request.auth.uid
        && request.resource.data.name is string
        && request.resource.data.description is string
        && request.resource.data.deadline is timestamp;

      // Updates
      allow update: if request.auth != null && (
        // Case 1: group creator updating anything
        (request.auth.uid == resource.data.creatorId)

        ||

        // Case 2: a member updating ONLY their own list
        (
          request.auth.uid in resource.data.members
          && request.resource.data.lists[request.auth.uid] == request.resource.data.lists[request.auth.uid] // user modifies only their list
          && request.resource.data == resource.data
              .diff({"lists": {request.auth.uid: request.resource.data.lists[request.auth.uid]}})
        )
      );

      // Only the creator can delete
      allow delete: if request.auth != null
        && resource.data.creatorId == request.auth.uid;
    }
  }
}
